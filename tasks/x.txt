---
# Install basic packages
- name: Create misp user
  user:
    name: misp
    state: present

- name: Create Ansible directory
  file: 
    path: "/home/misp/ansible"
    owner: misp
    group: misp
    mode: 0775
    state: directory

- name: install apache2 / mysql client
  apt: 
    pkg: "{{ item }}"
    state: latest
    update_cache: yes
  with_items: 
    - mysql-client
    - apache2
    - apache2-utils
  
- name: Install dependenceies
  apt: 
    pkg: "{{ item }}"
    state: latest
    update_cache: yes
  with_items: 
    - curl
    - gcc
    - git
    - gnupg-agent
    - make
    - python
    - openssl
    - redis-server
    - sudo
    - vim
    - zip
    - python-dev
    - python-pip
    - libxml2-dev
    - libxslt1-dev
    - zlib1g-dev

- name: Install php dependencies
  apt: 
    pkg: "{{ item }}"
    state: latest
    update_cache: yes
  with_items: 
    - libapache2-mod-php
    - php
    - php-crypt-gpg
    - php-dev
    - php-json
    - php-mysql
    - php-opcache
    - php-readline
    - php-redis
    - php-dev

 ######### MISP users and groups #########
 
- name: Add MISP group
  group:
    name: "{{ item }}"
    state: present
    system: yes
  with_items:
    - "misp-server"

- name: Add misp in misp-server
  user:
    name: misp
    append: yes
    groups: misp-server
    state: present

- name: Add www-data in misp-server
  user: 
    name: www-data
    append: yes
    groups: misp-server

######### MISP directories #########

- name: Create MISP server directory
  file:
    path: "{{ item }}"
    owner: misp
    group: misp-server
    mode: 02775
    state: directory
  with_items: 
    - "/opt/misp-server"
    - "/opt/misp-server/misp"
    - "/opt/misp-server/tmp"


######### MISP REPOSITORY #########

- name: Clone MISP repository
  become: true
  become_user: misp
  git: 
    repo: "https://github.com/MISP/MISP.git"
    dest: "/opt/misp-server/misp"
    recursive: yes
    force: no
    update: no
    version: v2.4.49
    accept_hostkey: yes
 
- name: Configure Git
  become: true
  become_user: misp
  command: git config --global core.filemode false
    creates=/home/misp/.gitconfig
    warn=no

- name: Create scripts directories
  file: 
    path: "{{ item }}"
    owner: misp
    group: misp-server
    mode: 02775
    state: directory
  with_items:
    - "/opt/misp-server/misp/app/files/scripts/python-cybox"
    - "/opt/misp-server/misp/app/files/scripts/python-stix"

- name: Clone MISP depedencies | Python-Cybox
  become: true
  become_user: misp
  git: 
    repo: "https://github.com/CybOXProject/python-cybox.git"
    dest: "/opt/misp-server/misp/app/files/scripts/python-cybox"
    force: no
    update: no
    version: v2.1.0.12
    accept_hostkey: yes

- name: Clone MISP depedencies | Python-Stix
  become: true
  become_user: misp
  git: 
    repo: "https://github.com/STIXProject/python-stix.git"
    dest: "/opt/misp-server/misp/app/files/scripts/python-stix"
    force: no
    update: no
    version: v1.1.1.4
    accept_hostkey: yes

- name: Install MISP depedencies | Python-Cybox
  become: true
  shell: "{{ item }}"
  args:
    chdir: /opt/misp-server/misp/app/files/scripts/python-cybox
    creates: /home/misp/ansible/ansible_shell_pythoncybox_setup.log
  with_items:
    - python setup.py install > /home/misp/ansible/ansible_shell_pythoncybox_setup.log

- name: Install MISP depedencies | Python-Stix
???LINES MISSING
- name: MySQL | get num tables
  set_fact:
    num_tables: "{{ dbase_tables.stdout | int }}"
    
- name: "MyMSQL  | Initialize MISP database {{ misp.db.name }} {{ num_tables }}"
  become: true
  become_user: misp
  shell:  mysql -D {{ misp.db.name }} < /opt/misp-server/misp/INSTALL/MYSQL.sql
  when: "{{ num_tables == 0 }}"

 # ######### PERMISSIONS #########
 # 
- name: Fix all files permissions
  file:
    path: /opt/misp-server/misp
    recurse: yes
    state: directory
    mode: "g=u"

#######       BACKUP      #######

## - name: Configure and enable MISP backup
##   include: backup.yml
##   when: enable_auto_backup == 'y'
## 
## ####### NEW DATA LOCATION #######
## 
## - name: Change DATA location of MISP
##   include: new_data_location.yml
##   when: data_location != '/opt/misp-server/misp/app'
## 
## #######   MISP-MODULES    #######
## 
- name: Install misp-modules
  include: modules.yml
  when: misp.install_modules
